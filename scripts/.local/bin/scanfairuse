#!/bin/sh

# This script validates whether there's ANY problems with the Fair Use playlist. If this script
# does not yield any errors, all the music on the Fair Use playlist should be safe to play live.
#
# ACTIONS:
# 1. Read all paths from the Fair Use playlist and examine the files' metadata.
# 2. If some tag is missing, the script will run "addfairuse" to prompt the user for correction.
# 3. If the artist name does not exist on the artists.yaml file, print that artists' name.
#
# DEPENDENCIES
# - rsid3

pl="$HOME/Music/Playlists/#Fair Use.m3u"
base="$HOME/Music"
artists="$HOME/Music/Playlists/artists.yaml"

# Normally if a WCOP frame (license URL) is missing, this script
# will warn about that. However, if  the TCOP (license name) frame
# matches this whitelisted phrase, WCOP will be ignored.
whitephrase="Approved Via Direct Message"

# To avoid repeating the same warnings,
# they will be dumped into this variable
warnings=

while read -r relative <&3; do
    f="$base/$relative"
    [ ! -f "$f" ] && echo "invalid path \"$f\" detected, run plfix." >&2 && exit 1

    artist="$(rsid3 --TPE1 -- "$f" 2>/dev/null)"
    license="$(rsid3 --TCOP -- "$f" 2>/dev/null)"

    if  [ -z "$artist" ] || \
        [ -z "$license" ] || \
        ! rsid3 --TIT2 -- "$f" >/dev/null 2>&1 || \
        ! rsid3 --WXXX origin -- "$f" >/dev/null 2>&1;
    then
        printf "tags missing from '%s', running addfairuse...\n" "$relative"
        sleep 1
        addfairuse "$f"
    elif ! rsid3 --WCOP -- "$f" >/dev/null 2>&1 && [ "$license" != "$whitephrase" ]; then
        warning="$(printf "warning: license '%s' has no URL (%s)" "$license" "$relative")"
        printf "%s" "$warnings" | grep -q "$warning" || {
            printf "%s\n" "$warning"
            warnings="$warnings\n$warning"
        }
    elif ! grep -qF "artist: $artist" "$artists"; then
        warning="$(printf "'%s' not found in artists.yaml" "$artist")" 
        printf "%s" "$warnings" | grep -q "$warning" || {
            printf "%s\n" "$warning"
            warnings="$warnings\n$warning"
        }
    fi
done 3<"$pl"

